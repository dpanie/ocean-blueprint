<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Take Action Raffle | Ocean Blueprint</title>

  <style>
    :root{
      --bg: #071018;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(0,0,0,0.22);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --muted2: rgba(255,255,255,0.62);
      --line: rgba(255,255,255,0.12);
      --accent: #78beff;
      --accent2: rgba(120,190,255,0.18);
      --shadow: 0 22px 70px rgba(0,0,0,0.45);
      --shadow2: 0 10px 26px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 900px at 70% 10%, rgba(120,190,255,0.14), transparent 55%),
        radial-gradient(900px 700px at 20% 80%, rgba(120,190,255,0.08), transparent 55%),
        var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      font-size: 19px;
      line-height: 1.65;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    a{ color:inherit; }
    a:focus-visible, button:focus-visible, textarea:focus-visible{
      outline: 3px solid rgba(120,190,255,0.55);
      outline-offset: 3px;
      border-radius: 10px;
    }

    /* ===== Topbar ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 30;
      height: 72px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 14px;
      padding: 0 18px;
      background: rgba(7,16,24,0.74);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .brand{
      font-weight: 750;
      letter-spacing: 0.2px;
      font-size: 16px;
      white-space: nowrap;
      display:flex;
      align-items:center;
      gap: 10px;
      text-decoration: none;
    }
    .brand-mark{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent2);
    }
    .nav{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .nav-btn{
      text-decoration:none;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.90);
      font-size: 15px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .nav-btn:hover{
      background: rgba(255,255,255,0.09);
      border-color: rgba(255,255,255,0.26);
      transform: translateY(-1px);
    }

    /* ===== Page container ===== */
    .page{
      width: min(1120px, calc(100% - 40px));
      margin: 0 auto;
      padding: 18px 0 42px;
    }

    /* ===== Hero banner (same vibe as OA page) ===== */
    .hero{
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background:
        linear-gradient(180deg, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0.84) 78%),
        radial-gradient(900px 420px at 70% 20%, rgba(120,190,255,0.18), transparent 60%),
        url("https://images.unsplash.com/photo-1500375592092-40eb2168fd21?auto=format&fit=crop&w=2400&q=80");
      background-size: cover;
      background-position: center;
      box-shadow: var(--shadow);
    }
    .hero-inner{
      padding: 34px 22px 18px;
      text-align: left;
    }
    .kicker{
      display:inline-flex;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,0.82);
      font-size: 13px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }
    .kicker-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent2);
    }
    .h1{
      margin: 10px 0 0;
      font-size: clamp(34px, 4.2vw, 56px);
      line-height: 1.06;
      letter-spacing: -0.9px;
    }
    .h4{
      margin: 10px 0 0;
      font-size: clamp(25px, 4.2vw, 56px);
      color: rgba(255,0,0,0.82);
      line-height: 1.06;
      letter-spacing: -0.9px;
    }
    .p{
      margin: 12px 0 0;
      color: rgba(255,255,255,0.86);
      font-size: 18px;
      max-width: 900px;
    }
    .badge-row{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 14px;
    }
    .badge{
      font-size: 14px;
      color: rgba(255,255,255,0.86);
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      padding: 7px 10px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    /* ===== Cards ===== */
    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      box-shadow: var(--shadow2);
      padding: 16px;
    }
    .section{ margin-top: 16px; }

    .section-title{
      margin: 0 0 6px;
      font-weight: 760;
      letter-spacing: -0.2px;
      font-size: 20px;
      color: rgba(255,255,255,0.94);
    }
    .section-sub{
      margin: 0;
      color: rgba(255,255,255,0.72);
      font-size: 15.5px;
      line-height: 1.55;
    }

    /* ===== Form elements ===== */
    label{
      display:block;
      margin-top: 12px;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.86);
      font-size: 14px;
      font-weight: 650;
    }
    textarea{
      width: 100%;
      min-height: 110px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      font-size: 15.5px;
      line-height: 1.5;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
    }
    textarea::placeholder{ color: rgba(255,255,255,0.45); }

    .hint{
      margin: 6px 0 0;
      color: rgba(255,255,255,0.62);
      font-size: 13.5px;
      line-height: 1.5;
    }

    /* ===== Buttons ===== */
    .btn-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
      align-items: center;
    }
    .btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.20);
      background: rgba(0,0,0,0.22);
      color: rgba(255,255,255,0.92);
      font-size: 14px;
      font-weight: 650;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.35);
      transform: translateY(-1px);
    }
    .btn-primary{
      border-color: rgba(120,190,255,0.55);
      background: rgba(120,190,255,0.14);
    }
    .btn-danger{
      border-color: rgba(255,140,140,0.35);
      background: rgba(255,140,140,0.10);
    }
    .status{
      margin-left: auto;
      color: rgba(255,255,255,0.70);
      font-size: 13.5px;
    }

    /* ===== Layout grid ===== */
    .grid{
      display:grid;
      gap: 16px;
      margin-top: 16px;
    }
    .grid-2{
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 980px){
      .grid-2{ grid-template-columns: 1fr; }
      .status{ margin-left: 0; width: 100%; }
    }

    /* ===== Google Form embed ===== */
    .embed{
      width: 100%;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      overflow: hidden;
      background: rgba(0,0,0,0.22);
      box-shadow: var(--shadow2);
    }
    .embed iframe{
      width: 100%;
      height: 680px;
      border: 0;
      display:block;
    }
    .embed-note{
      margin-top: 10px;
      color: rgba(255,255,255,0.62);
      font-size: 13.5px;
      line-height: 1.5;
    }

    /* ===== Posts ===== */
    .posts{
      display:grid;
      gap: 12px;
      margin-top: 12px;
    }
    .post{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      padding: 12px 12px 12px;
    }
    .post-top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      margin-bottom: 10px;
    }
    .alias{
      font-weight: 750;
      letter-spacing: 0.1px;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
    }
    .when{
      font-size: 12.5px;
      color: rgba(255,255,255,0.60);
      white-space: nowrap;
    }
    .qa{
      display:grid;
      gap: 10px;
    }
    .q{
      font-size: 13px;
      color: rgba(255,255,255,0.64);
      text-transform: uppercase;
      letter-spacing: 0.35px;
      margin-bottom: 3px;
    }
    .a{
      margin:0;
      color: rgba(255,255,255,0.86);
      font-size: 15.5px;
      line-height: 1.55;
      white-space: pre-wrap;
    }

    .footer{
      text-align: center;
      padding: 18px 12px;
      margin-top: 26px;
      border-top: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.70);
      font-size: 14px;
    }

    @media (prefers-reduced-motion: reduce){
      .nav-btn, .btn{ transition: none; }
    }

    @media (max-width: 768px) {
      .topbar {
        flex-direction: column; /* Stacks Brand logo on top of buttons */
        padding: 15px 10px;
        gap: 15px;
      }

      .nav {
        justify-content: center; /* Centers buttons on mobile */
        width: 100%;
      }

      .nav-btn {
        font-size: 13px; /* Slightly smaller text for mobile */
        padding: 6px 10px;
      }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <a class="brand" href="index.html">
      <span class="brand-mark" aria-hidden="true"></span>
      <span>Ocean Blueprint</span>
    </a>

    <nav class="nav" aria-label="Primary">
      <a class="nav-btn" href="index.html">Home</a>
      <a class="nav-btn" href="what-is-acidification.html">What is OA?</a>
      <a class="nav-btn" href="why-it-matters.html">Why it matters</a>
      <a class="nav-btn" href="solutions.html">Solutions</a>
      <a class="nav-btn" href="take-action.html">Take action</a>
      <a class="nav-btn" href="quiz.html">Game</a>
    </nav>
  </header>

  <main class="page">
    <section class="hero" aria-label="Raffle banner">
      <div class="hero-inner">
        <div class="kicker"><span class="kicker-dot" aria-hidden="true"></span>Community action</div>
        <h1 class="h1">Take Action Raffle</h1>
        <h4 class="h4">Fill out Parts 1 and 2 to be Eligible</h4>  
        <p class="p">
          Enter the $100 raffle by submitting your contact info (private) and posting one ocean acidification fact + one action you can take (public).
          Use information from this site and outside sources if you want.
        </p>
      </div>
    </section>

    <div class="grid grid-2">
      <!-- Step 1 -->
      <section class="card section" aria-label="Step 1">
        <h2 class="section-title">Step 1 — Raffle entry (private)</h2>
        <p class="section-sub">
          Submit your email or phone using the embedded Google Form below. 
        </p>

        <div class="section embed" style="margin-top:12px;">
          <!-- NOTE: using "embedded" form URL format -->
          <iframe
            title="Raffle entry form"
            src="https://docs.google.com/forms/d/e/1FAIpQLSfSu8xkk7Nb-C-0afV3mv4cz_t2J2_ZfzQOeq51Byf_ouj3-g/viewform?usp=publish-editor">
          </iframe>
        </div>
        <p class="embed-note">
          If the form does not load, make sure the form is published and accepts responses.
        </p>
      </section>

      <!-- Step 2 -->
      <section class="card section" aria-label="Step 2">
        <h2 class="section-title">Step 2 — Post on the community board to enter the raffle! (public)</h2>

        <label for="fact">1) One fact about ocean acidification</label>
        <textarea id="fact" maxlength="500" placeholder="Example: When CO₂ dissolves in seawater, it increases H⁺ and reduces carbonate ions, making it harder for shell-building organisms to calcify."></textarea>
        <p class="hint"><span id="factCount">0</span>/500 characters (min 10)</p>

        <label for="action">2) One thing you can do to help</label>
        <textarea id="action" maxlength="500" placeholder="Example: Reduce personal CO₂ emissions and support local shellfish reef restoration or seagrass projects."></textarea>
        <p class="hint"><span id="actionCount">0</span>/500 characters (min 10)</p>

        <div class="btn-row">
          <button class="btn btn-primary" id="postBtn" type="button">Post</button>
          <button class="btn btn-danger" id="clearBtn" type="button">Clear</button>
          <div class="status" id="status">Not posted yet.</div>
        </div>

        <div class="section" style="margin-top:16px;">
          <h3 class="section-title" style="font-size:18px;">Recent posts</h3>
          <p class="section-sub" id="postsHint">Loading…</p>
          <div class="posts" id="posts"></div>
        </div>
      </section>
    </div>

    <footer class="footer">
      Ocean Blueprint • Community board posts are public. Do not post personal information.
    </footer>
  </main>

  <!-- Firebase + Firestore (CDN, works fine inside HTML) -->
  <script type="module">
    // ===== 1) Firebase imports (modular SDK) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      limit,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // ===== 2) Your Firebase config =====
    // NOTE: This is safe to be public. Security comes from Firestore rules.
    const firebaseConfig = {
      apiKey: "AIzaSyBPC4gV_qJN_sgZlzt1s5XhI3DUOYpDrus",
      authDomain: "ocean-blueprint.firebaseapp.com",
      projectId: "ocean-blueprint",
      storageBucket: "ocean-blueprint.firebasestorage.app",
      messagingSenderId: "613311127660",
      appId: "1:613311127660:web:3985ecf844877946c83849"
    };

    // ===== 3) Init Firebase =====
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== 4) UI helpers =====
    const factEl = document.getElementById("fact");
    const actionEl = document.getElementById("action");
    const factCountEl = document.getElementById("factCount");
    const actionCountEl = document.getElementById("actionCount");
    const postBtn = document.getElementById("postBtn");
    const clearBtn = document.getElementById("clearBtn");
    const statusEl = document.getElementById("status");
    const postsEl = document.getElementById("posts");
    const postsHintEl = document.getElementById("postsHint");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function updateCounts() {
      factCountEl.textContent = String(factEl.value.length);
      actionCountEl.textContent = String(actionEl.value.length);
    }

    factEl.addEventListener("input", updateCounts);
    actionEl.addEventListener("input", updateCounts);
    updateCounts();

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#039;"
      }[c]));
    }

    // Random, non-identifying alias (no user input)
    function randomAlias() {
      const words = ["Wave", "Tide", "Reef", "Shell", "Current", "Blue", "Ocean", "Coral"];
      const w = words[Math.floor(Math.random() * words.length)];
      const n = Math.floor(1000 + Math.random() * 9000);
      return `${w}-${n}`;
    }

    // Firestore timestamp isn't required by your rules, so we skip it.
    // (If you want time displayed reliably, you’d need serverTimestamp + rules allowing it.)
    function approxTimeLabel() {
      const d = new Date();
      return d.toLocaleString(undefined, { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
    }

    // ===== 5) Post handler (MUST match your rules exactly) =====
    postBtn.addEventListener("click", async () => {
      const fact = factEl.value.trim();
      const action = actionEl.value.trim();

      if (fact.length < 10 || action.length < 10) {
        setStatus("Both answers must be at least 10 characters.");
        return;
      }
      if (fact.length > 500 || action.length > 500) {
        setStatus("Max 500 characters per answer.");
        return;
      }

      postBtn.disabled = true;
      postBtn.textContent = "Posting…";
      setStatus("Posting…");

      try {
        await addDoc(collection(db, "raffle_posts"), {
          page: "contest",
          alias: randomAlias(),
          fact,
          action
        });

        factEl.value = "";
        actionEl.value = "";
        updateCounts();
        setStatus("Posted.");
      } catch (e) {
        console.error(e);
        setStatus("Post failed. Open DevTools → Console to see the error.");
      } finally {
        postBtn.disabled = false;
        postBtn.textContent = "Post";
      }
    });

    clearBtn.addEventListener("click", () => {
      factEl.value = "";
      actionEl.value = "";
      updateCounts();
      setStatus("Cleared.");
    });

    // ===== 6) Live feed =====
    // NOTE: Because you didn’t store timestamps, ordering isn’t perfect.
    // We’ll still try: Firestore can’t orderBy a field that doesn’t exist.
    // So we will just listen to the whole collection and render the newest docs as Firestore returns them.
    // Better solution: add createdAt: serverTimestamp() and allow it in rules.
    function renderPosts(docs) {
      if (!docs.length) {
        postsHintEl.textContent = "No posts yet.";
        postsEl.innerHTML = "";
        return;
      }

      postsHintEl.textContent = "Showing recent activity.";
      postsEl.innerHTML = docs.map((d) => {
        const data = d.data();
        const alias = typeof data.alias === "string" ? data.alias : "Wave-0000";
        const fact = typeof data.fact === "string" ? data.fact : "";
        const action = typeof data.action === "string" ? data.action : "";
        return `
          <div class="post">
            <div class="post-top">
              <div class="alias">${escapeHtml(alias)}</div>
              <div class="when">${escapeHtml(approxTimeLabel())}</div>
            </div>
            <div class="qa">
              <div>
                <div class="q">Fact</div>
                <p class="a">${escapeHtml(fact)}</p>
              </div>
              <div>
                <div class="q">Action</div>
                <p class="a">${escapeHtml(action)}</p>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    // Listener (simple)
    // If your collection grows large, you must change this to a limited query using a createdAt field.
    onSnapshot(collection(db, "raffle_posts"), (snapshot) => {
      // Render last ~20 docs from snapshot order (not guaranteed chronological).
      const docs = snapshot.docs.slice(-20).reverse();
      renderPosts(docs);
    }, (err) => {
      console.error(err);
      postsHintEl.textContent = "Could not load posts. Check Firestore rules + console.";
    });
  </script>
</body>
</html>
